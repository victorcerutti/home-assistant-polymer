<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">

<script>
class StateHistoryChartTimeline extends Polymer.Element {
  static get is() { return 'state-history-chart-timeline'; }
  static get properties() {
    return {
      data: {
        type: Object,
      },
      noSingle: Boolean,
      endTime: Date,
    };
  }

  static get observers() {
    return ['dataChanged(data, endTime)'];
  }

  connectedCallback() {
    super.connectedCallback();
    this._isAttached = true;
    this.drawChart();

    this._resizeListener = () => {
      this._debouncer = Polymer.Debouncer.debounce(
        this._debouncer,
        Polymer.Async.timeOut.after(10),
        () => {
          if (this._isAttached) {
            this.drawChart();
          }
        }
      );
    };
    window.addEventListener('resize', this._resizeListener);
  }

  disconnectedCallback() {
    super.disconnectedCallback();
    this._isAttached = false;
    window.removeEventListener('resize', this._resizeListener);
  }

  dataChanged() {
    this.drawChart();
  }

  drawChart() {
    var stateHistory = this.data;
    var chart;
    var dataTable;
    var startTime;
    var endTime;
    var numTimelines;
    var format;
    var daysDelta;

    if (!this._isAttached) {
      return;
    }

    while (this.lastChild) {
      this.removeChild(this.lastChild);
    }

    if (!stateHistory || stateHistory.length === 0) {
      return;
    }

    chart = new window.google.visualization.Timeline(this);
    dataTable = new window.google.visualization.DataTable();

    dataTable.addColumn({ type: 'string', id: 'Entity' });
    dataTable.addColumn({ type: 'string', id: 'State' });
    dataTable.addColumn({ type: 'string', role: 'tooltip', p: { html: true } });
    dataTable.addColumn({ type: 'date', id: 'Start' });
    dataTable.addColumn({ type: 'date', id: 'End' });


    function addRow(entityDisplay, stateStr, start, end) {
      var stateDisplay = stateStr.replace(/_/g, ' ');

      var dateFormat = new google.visualization.DateFormat({
            pattern: 'h:mm a'
        });

      function diffTime(start,end) {
        var milisec_diff = new Date( end ).getTime() - new Date( start ).getTime();
        console.log(milisec_diff)
        var days = Math.floor(milisec_diff / 1000 / 60 / (60 * 24));
        console.log(days)
        var date_diff = new Date( milisec_diff );
        console.log(date_diff)
        console.log(date_diff.getHours());
        console.warn(days + " Days "+ date_diff.getHours() + " Hours " + date_diff.getMinutes() + " Minutes " + date_diff.getSeconds() + " Seconds")
        var tooltip = ""+days + " Days "+ date_diff.getHours() + " Hours " + date_diff.getMinutes() + " Minutes " + date_diff.getSeconds() + " Seconds";
        console.log(typeof tooltip);
        return tooltip;

      }

      var tooltip = '<ul class="google-visualization-tooltip-item-list">'
        + '<li class="google-visualization-tooltip-item" style="">'
        + '<span style="font-family: Arial; font-size: 12px; color: rgb(0, 0, 0); margin: 0px; text-decoration: none; font-weight: bold;">'+stateDisplay+'</span>'
        + '</li>'
        + '</ul>'
        + '<div class="google-visualization-tooltip-separator"></div>'
        + '<ul class="google-visualization-tooltip-item-list">'
        + '<li class="google-visualization-tooltip-item" style="">'
        + '<span style="font-family: Arial; font-size: 12px; color: rgb(0, 0, 0); margin: 0px; text-decoration: none; font-weight: bold;">'+entityDisplay+':</span> '
        + '<span style="font-family: Arial; font-size: 12px; color: rgb(0, 0, 0); margin: 0px; text-decoration: none;">'
        + dateFormat.formatValue(start)+' - '+dateFormat.formatValue(end)
        + '</span>'
        + '</li>'
        + '<li class="google-visualization-tooltip-item" style="">'
        + '<span style="font-family: Arial; font-size: 12px; color: rgb(0, 0, 0); margin: 0px; text-decoration: none; font-weight: bold;">Duration:</span> '
        + '<span style="font-family: Arial; font-size: 12px; color: rgb(0, 0, 0); margin: 0px; text-decoration: none;">'+diffTime(start,end)
        +'</span>'
        + '</li>'
        + '</ul>'

      dataTable.addRow([entityDisplay, stateDisplay, tooltip, start, end]);
    }

    startTime = new Date(stateHistory.reduce(function (minTime, stateInfo) {
      return Math.min(minTime, new Date(stateInfo.data[0].last_changed));
    }, new Date()));

    // end time is Math.max(startTime, last_event)
    endTime = this.endTime ||
      new Date(stateHistory.reduce(function (maxTime, stateInfo) {
        return Math.max(
          maxTime,
          new Date(stateInfo.data[stateInfo.data.length - 1].last_changed)
        );
      }, startTime));

    if (endTime > new Date()) {
      endTime = new Date();
    }
    format = 'H:mm';
    daysDelta = (endTime - startTime) / (24 * 3600 * 1000);
    // Avoid rounding up when the API returns a few extra seconds.
    if (daysDelta > 30.1) {
      format = 'MMM d';
    } else if (daysDelta > 3.1) {
      format = 'EEE, MMM d';
    } else if (daysDelta > 1.1) {
      format = 'EEE, MMM d, H:mm';
    }

    numTimelines = 0;
    // stateHistory is a list of lists of sorted state objects
    stateHistory.forEach(function (stateInfo) {
      var entityDisplay;
      var newLastChanged;
      var prevState = null;
      var prevLastChanged = null;

      if (stateInfo.data.length === 0) return;

      entityDisplay = stateInfo.name;

      stateInfo.data.forEach(function (state) {
        var timeStamp = new Date(state.last_changed);
        if (timeStamp > endTime) {
          // Drop datapoints that are after the requested endTime. This could happen if
          // endTime is "now" and client time is not in sync with server time.
          return;
        }
        if (prevState !== null && state.state !== prevState) {
          newLastChanged = new Date(state.last_changed);

          addRow(entityDisplay, prevState, prevLastChanged, newLastChanged);

          prevState = state.state;
          prevLastChanged = newLastChanged;
        } else if (prevState === null) {
          prevState = state.state;
          prevLastChanged = new Date(state.last_changed);
        }
      });

      if (prevState !== null) {
        addRow(entityDisplay, prevState, prevLastChanged, endTime);
      }
      numTimelines++;
    });

    console.log(dataTable);

    chart.draw(dataTable, {
      backgroundColor: '#fafafa',

      height: 55 + (numTimelines * 42),

      timeline: {
        showRowLabels: this.noSingle || stateHistory.length > 1,
      },

      hAxis: {
        format: format
      },

      tooltip: {
        isHtml: true
      }

    });
  }
}
customElements.define(StateHistoryChartTimeline.is, StateHistoryChartTimeline);
</script>
